---
title: "dNdSCV on LUAD"
author: "Sehyun Oh"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

GitHub page for dNdScr: https://github.com/im3sanger/dndscv

```{r echo=FALSE, results="hide", warning=FALSE}
suppressPackageStartupMessages({
    library(dndscv)
    library(dplyr)
})
```

# Set-up environment
Outputs are in two directories: `tumor_only` (`i=1`) and `matching_normal` (`i=2`)

```{r setup_1}
# Select runtype
i = 1

runtype = c("tumor_only", "matching_normal")[i]
wd = "~/data2/PureCN_manuscript/Revision/dNdSCV"
dnds_out_dir = file.path("/nobackup/16tb_b/CNVworkflow_revision/dNdSCV/outputs/LUAD", runtype)
```



# Build a reference for dNdSCV
```{r eval=FALSE}
path_cds_table = file.path(wd, "mart_export.txt")
path_genome_fasta = "~/reference/GRCh38_no_alt/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna"

# Build GRCh38 reference
buildref(cdsfile = path_cds_table, 
         genomefile = path_genome_fasta, 
         outfile = file.path(wd, "GRCh38_refcds.rda"), 
         excludechrs = "MT")
```





# Prepare SNV mutations table from PureCN
`buildSNVtable.R` script requires a runtype (`i`), output directory (`out_dir`), and
PureCN output data directory (`data_dir`). Ouput from this script is a list of SNV 
mutation tables (`snv_list`). 

- input: `i`, `out_dir`, `data_dir`   
- output: `snv_list`   

```{r eval=FALSE}
out_dir = "~/data2/PureCN_manuscript/Revision/dNdSCV"
data_dir = file.path("/nobackup/16tb_a/CNVworkflow_LUAD/purecn_output/PureCN", runtype)

source("~/data2/PureCN_manuscript/Revision/dNdSCV/script/buildSNVtable.R")
```


# Format mutation table
## Load a list of SNV tables
```{r setup_2}
snv_list = readRDS(file.path(wd, paste0("LUAD_mutTable_", runtype, ".rds")))
names(snv_list) = stringr::str_extract(names(snv_list), "TCGA.{11}")
```

## Format a list of SNV tables
Main focus is merging MNPs.
```{r eval=TRUE}
source("~/data2/PureCN_manuscript/Revision/dNdSCV/script/formatSNVTables.R")
```


# Run dNdSCV
```{r eval=TRUE}
source("~/data2/PureCN_manuscript/Revision/dNdSCV/script/rundNdSCV.R")
```


## Excluded samples 
We have run dNdScv with default parameters. This includes removing ultra-hypermutator
samples and subsampling mutations when encountering too many mutations per gene in the
same sample. These were designed to protect against loss of sensitivity from 
ultra-hypermutators and from clustered artefacts in the input mutation table, but 
there are occasions when the user will prefer to relax these.   

```{r}
# sample failed to be processed by dNdSCV with default filtering
dndsout_all = list.files(dnds_out_dir)
missing_ind = which(!names(snv_list) %in% gsub(".rds", "", dndsout_all))
```

From `r runtype` PureCN analysis, `r length(missing_ind)` samples were excluded 
for exceeding the limit of mutations per sample (see the max_coding_muts_per_sample argument in dndscv).




# EDA on dNdSCV outputs
## Load `sel_cv` objects
`sel_cv` is gene-wise selection results using dNdScv.

```{r eval=FALSE}
i = 2
runtype = c("tumor_only", "matching_normal")[i]

sel_cv_fname = list.files(file.path(dnds_out_dir, "sel_cv"))
sel_cv_path = file.path(dnds_out_dir, "sel_cv", sel_cv_fname)

sel_cv_all = lapply(sel_cv_path, function(x) {
    y = read.csv(x)
    y = data.frame(y[-1], row.names = y[,1])
    assign(x, y)
})

saveRDS(sel_cv_all, file = file.path(out_dir, paste0("LUAD_sel_cv_", runtype, ".rds")))
```

```{r}
signif_genes = sel_cv[sel_cv$qglobal_cv < 0.1, c("gene_name", "qglobal_cv")]
rownames(signif_genes) = NULL
print(signif_genes)
```






