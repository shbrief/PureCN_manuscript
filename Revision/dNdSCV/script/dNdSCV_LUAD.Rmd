---
title: "dNdSCV on LUAD"
author: "Sehyun Oh"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

GitHub page for dNdScr: https://github.com/im3sanger/dndscv
dNdScr vignette: http://htmlpreview.github.io/?http://github.com/im3sanger/dndscv/blob/master/vignettes/dNdScv.html

```{r echo=FALSE, results="hide", warning=FALSE}
suppressPackageStartupMessages({
    library(dndscv)
    library(dplyr)
})
```

# Set-up environment
Outputs are in two directories: `tumor_only` (`i=1`) and `matching_normal` (`i=2`)

```{r setup_1}
# Select runtype
i = 1

runtype = c("tumor_only", "matching_normal")[i]
wd = "~/data2/PureCN_manuscript/Revision/dNdSCV"
dnds_out_dir = file.path("/nobackup/16tb_b/CNVworkflow_revision/dNdSCV/outputs/LUAD", runtype)
```



# Build a reference for dNdSCV
```{r eval=FALSE}
path_cds_table = file.path(wd, "mart_export.txt")
path_genome_fasta = "~/reference/GRCh38_no_alt/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna"

# Build GRCh38 reference
buildref(cdsfile = path_cds_table, 
         genomefile = path_genome_fasta, 
         outfile = file.path(wd, "GRCh38_refcds.rda"), 
         excludechrs = "MT")
```





# Prepare SNV mutations table from PureCN
`buildSNVtable.R` script requires a runtype (`i`), output directory (`out_dir`), and
PureCN output data directory (`data_dir`). Ouput from this script is a list of SNV 
mutation tables (`snv_list`). 

- input: `i`, `out_dir`, `data_dir`   
- output: `snv_list`   

```{r buildSNVTable, eval=FALSE}
out_dir = "~/data2/PureCN_manuscript/Revision/dNdSCV"
data_dir = file.path("/nobackup/16tb_a/CNVworkflow_LUAD/purecn_output/PureCN", runtype)

source("~/data2/PureCN_manuscript/Revision/dNdSCV/script/buildSNVTable.R")
```


# Format mutation table
## Load a list of SNV tables
```{r setup_2}
snv_list = readRDS(file.path(wd, paste0("LUAD_mutTable_", runtype, ".rds")))
names(snv_list) = stringr::str_extract(names(snv_list), "TCGA.{11}")
```

## Format a list of SNV tables
* Input: `snv_list`, which is a SNPs/MNPs table before formatting      
* Output: `res`, which is a properly formatted SNPs/MNPs table, and potentially 
`mannual_snv_check`, which contains the samples with fewer than 3 SNVs. You need 
to check it manually (there will be a message in this case) and add back to the `res`.

```{r eval=TRUE}
source("~/data2/PureCN_manuscript/Revision/dNdSCV/script/formatSNVTable.R")
```

```{r eval=TRUE}
snv_list = c(snv_list, mannual_snv_check)
snv_list = res   # assign 
```


# Run dNdSCV
* Input: `snv_list`, which is the properly formatted SNPs/MNPs table   
* Output: `dndsout`, which is an output from `dndscv::dndscv` function

```{r eval=TRUE}
source("~/data2/PureCN_manuscript/Revision/dNdSCV/script/rundNdSCV.R")
```

```{r echo=FALSE, eval=FALSE}
saveRDS(dndsout, file = file.path(dnds_out_dir, paste0("dndsout_LUAD_", runtype, ".rds")))
```


## Excluded samples 
We have run dNdScv with default parameters. This includes removing ultra-hypermutator
samples and subsampling mutations when encountering too many mutations per gene in the
same sample. These were designed to protect against loss of sensitivity from 
ultra-hypermutators and from clustered artefacts in the input mutation table, but 
there are occasions when the user will prefer to relax these.   



# EDA on dNdSCV outputs
`sel_cv` is gene-wise selection results using dNdScv.

```{r}
sel_cv = dndsout$sel_cv
signif_genes = sel_cv[sel_cv$qglobal_cv < 0.1, c("gene_name", "qglobal_cv")]
rownames(signif_genes) = NULL

print(signif_genes)
write.csv(signif_genes, file = file.path(dnds_out_dir, paste0("signif_genes_LUAD_", runtype, ".csv")))
```


```{r}
signif_dir = "/nobackup/16tb_b/CNVworkflow_revision/dNdSCV/outputs/LUAD"
t = read.csv(file.path(signif_dir, "tumor_only/signif_genes_LUAD_tumor_only.csv"))[,-1]
m = read.csv(file.path(signif_dir, "matching_normal/signif_genes_LUAD_matching_normal.csv"))[,-1]

colnames(t)[2] = "qglobal_cv_tumorOnly"
colnames(m)[2] = "qglobal_cv_matchingN"

all = merge(m, t, by = "gene_name")
```

```{r fig.width=4.5, fig.height=4.5}
library(VennDiagram)

grid.newpage()
draw.pairwise.venn(area1 = nrow(m),
                   area2 = nrow(t),
                   cross.area = nrow(all),
                   category = c("matching_normal", "tumor_only"),
                   lty = rep("blank", 2), 
                   fill = c("light blue", "pink"), 
                   alpha = rep(0.5, 2), 
                   cat.pos = c(0, 0), 
                   cat.dist = rep(0.025, 2))
```

```{r plot_signif_genes, fig.height=4.5, fig.width=4.5}
plot(x = -log(all$qglobal_cv_matchingN), 
     y = -log(all$qglobal_cv_tumorOnly),
     main = "Significant genes (-log(q-value))",
     xlab = "With matching-normal",
     ylab = "Tumor-only",
     xlim = c(0,16), ylim = c(0,16))
abline(0, 1, col = "red")
# with(all, text(all$qglobal_cv_matchingN ~ all$qglobal_cv_tumorOnly, 
#                labels = all$gene_name, 
#                cex = 0.7)
#      )
```





